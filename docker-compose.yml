# BetterBe - Docker Compose Setup
# 
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose logs -f api    # Follow API logs
#   docker-compose down           # Stop all services
#   docker-compose down -v        # Stop and remove volumes (deletes data!)

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: betterbe-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-betterbe}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-betterbe_secret}
      POSTGRES_DB: ${POSTGRES_DB:-betterbe}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-betterbe} -d ${POSTGRES_DB:-betterbe}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Rust API Backend
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: betterbe-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-betterbe}:${POSTGRES_PASSWORD:-betterbe_secret}@db:5432/${POSTGRES_DB:-betterbe}
      
      # JWT Secret (from .env)
      JWT_SECRET: ${JWT_SECRET:-change-this-super-secret-jwt-key-in-production}
      
      # Google OAuth (from .env)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-http://localhost:5173/auth/google/callback}
      
      # Apple Sign In (optional)
      APPLE_CLIENT_ID: ${APPLE_CLIENT_ID:-}
      APPLE_TEAM_ID: ${APPLE_TEAM_ID:-}
      APPLE_KEY_ID: ${APPLE_KEY_ID:-}
      APPLE_PRIVATE_KEY: ${APPLE_PRIVATE_KEY:-}
      APPLE_REDIRECT_URI: ${APPLE_REDIRECT_URI:-http://localhost:3000/auth/apple/callback}
      
      # Logging
      RUST_LOG: ${RUST_LOG:-betterbe_api=info,tower_http=info}
    ports:
      - "${API_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Optional: pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: betterbe-pgadmin
    restart: unless-stopped
    profiles:
      - tools
    depends_on:
      - db
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@betterbe.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  default:
    name: betterbe-network

